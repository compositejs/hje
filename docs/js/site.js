// Simple blog engine (by Kingcean Tuan)
let site={};!function(site){let rootContext,info={},strings={en:{name:"Name",article:"Article",articles:"Articles",articleMenu:"In this article",architecture:"Architecture",website:"Website",officialWebsite:"Official website",log:"Log",blog:"Blog",blogs:"Blogs",home:"Home",about:"About",game:"Game",games:"Games",video:"Video",videos:"Videos",screenshot:"Screenshot",screenshots:"Screenshots",photo:"Photo",photos:"Photos",pic:"Picture",pics:"Pictures",file:"File",files:"Files",lib:"Library",libs:"Libraries",package:"Package",packages:"Packages",tool:"Tool",tools:"Tools",book:"Book",books:"Books",comment:"Comment",comments:"Comments",docs:"Docs",search:"Search",settings:"Settings",tutorial:"Tutorial",learnMore:"Learn more",back:"Back",goHome:"Back to homepage",recomm:"Recommendation",ok:"OK",cancel:"Cancel",continue:"Continue",open:"Open",close:"Close",new:"New",add:"Add",modify:"Modify",remove:"Remove",delete:"Delete",empty:"Empty",loading:"Loading…",seeAlso:"See also",error:"Error",loadFailed:"Load failed.",renderFailed:"Render failed.",top:"Top",next:"Next",previous:"Previous",projects:"Projects",archiveProjects:"Archive projects",features:"Features",installation:"Installation",sourceCode:"Source",community:"Community",link:"Link",otherLinks:"Other links",relatedLinks:"Related links",more:"More…",getDetails:"Get details"},"zh-Hans":{name:"名称",article:"文章",articles:"文章",articleMenu:"文章目录",architecture:"架构",website:"网站",officialWebsite:"官网",log:"日志",blog:"博客",blogs:"博客",home:"首页",about:"关于",game:"游戏",games:"游戏",video:"视频",videos:"视频",screenshot:"截图",screenshots:"截图",photo:"照片",photos:"照片",pic:"图片",pics:"图片",file:"文件",files:"文件",lib:"库",libs:"库",package:"包",packages:"包",tool:"工具",tools:"工具",book:"书",books:"书",comment:"评论",comments:"评论",docs:"文档",search:"搜索",settings:"设置",tutorial:"教程",learnMore:"了解详情",back:"返回",goHome:"返回首页",recomm:"推荐",ok:"确定",cancel:"取消",continue:"继续",open:"打开",close:"关闭",new:"新建",add:"添加",modify:"修改",remove:"移除",delete:"删除",emty:"空",loading:"加载中…",seeAlso:"参考",error:"错误",loadFailed:"加载失败。",renderFailed:"渲染失败。",top:"返回顶部",next:"下一篇",previous:"上一篇",projects:"项目",archiveProjects:"归档项目",features:"功能",installation:"安装",sourceCode:"源码",community:"社区",link:"链接",otherLinks:"更多链接",relatedLinks:"相关链接",more:"更多…",getDetails:"获取详情"},value:{}},settings={};function initMarket(){if(strings.mkt)return strings.mkt;let lang=navigator.language||navigator.userLanguage||navigator.browserLanguage||navigator.systemLanguage||"";return strings.mkt=0===lang.startsWith("zh")||lang.endsWith("-CN")&&!lang.startsWith("en")?"zh-Hans":"en",strings.mkt}function scrollToTop(){window.scrollTo({top:0,behavior:"smooth"})}function fetchJson(url){return"undefined"==typeof fetch?"function"==typeof $&&"function"==typeof $.get?$.get(url):new Promise((function(resolve,reject){reject("Not implemented")})):fetch(url).then((function(r){return r.json()}))}function genHeadItem(ele,level){return{text:ele.innerText,level:level,scroll(){ele.scrollIntoView({behavior:"smooth"})}}}function genHeadModel(item,sub){let text=item.text;return sub&&(text="▹ "+text),{tagName:"li",children:[{tagName:"a",props:{href:"javascript:void(0)"},on:{click(ev){"function"==typeof item.scroll&&item.scroll()}},children:text}]}}function getHeadings(container){let arr=[];for(let i=0;i<container.children.length;i++){if(para=container.children[i],!para||!para.tagName)continue;let tagName=para.tagName.toLowerCase();switch(tagName){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":arr.push(genHeadItem(para,parseInt(tagName.replace("h",""))))}}return arr}function getChildModel(key){try{return rootContext.childContext(key).model()}catch(ex){}}function setChildChildren(key,children){let m=getChildModel(key);return m&&(m.children=children),m}function genNotification(value){return setChildChildren("content",[{tagName:"em",children:value}])}function resetContentMenu(){let m=getChildModel("cntMenu");if(m)return m.children=[],m.style={display:"none"},delete m.data,m}function highlightSelected(id,needRefresh){let menu=rootContext.childContext("articles");if(!menu)return;let ul=menu.model();if(!ul||!ul.children)return;let diff=!1;for(let i=0;i<ul.children.length;i++){let li=ul.children[i];if(li)if(id&&li.data===id)li.styleRefs||(li.styleRefs=["state-sel"],diff=!0);else{if(!li.styleRefs)continue;if("state-sel"===li.styleRefs){delete li.styleRefs,diff=!0;continue}if(!(li.styleRefs instanceof Array))continue;let j=li.styleRefs.indexOf("state-sel");if(j<0)continue;li.styleRefs.splice(j,1),diff=!0}}needRefresh&&menu.refresh()}function getSubFile(item,sub){if(!item||!sub||!item.subs)return{};sub.endsWith(".md")?(sub=sub.substring(0,sub.length-3)).endsWith("/README")&&(sub=sub.substring(0,sub.length-7)):sub.endsWith("/")&&(sub=sub.substring(0,sub.length-1));let id=sub;if(!0===item.subs)return{id:sub,file:sub+".md"};if(!(item.subs instanceof Array))return{};let sub1=sub+".md",sub2=sub+"/README.md";for(let i=0;i<item.subs.length;i++){let name,subItem=item.subs[i];if(subItem&&(subItem.startsWith("/")&&(subItem=subItem.substring(1)),"string"!=typeof subItem&&(subItem=subItem.url,name=subItem.name),subItem==sub1||subItem==sub2))return{id:id,file:subItem,name:name}}return{}}function setNextButton(key,id){let m=getChildModel(key);m&&(m.data=id,m.props||(m.props={}),id?(m.props.disabled=!1,m.props.href="?"+id):(m.props.disabled=!0,m.props.href="javascript:void(0)"))}function renderArticle(id){let context=rootContext;if(!context)return;highlightSelected(void 0),resetContentMenu(),setChildChildren("note",void 0);let relatedContainer=getChildModel("relatedContainer")||{};relatedContainer.style={display:"none"},relatedContainer.children=[];let item,sub,nextContainer=getChildModel("nextSection");if(nextContainer&&(nextContainer.style={display:"none"}),setNextButton("previousButton",void 0),setNextButton("nextButton",void 0),id){let subOffset=id.lastIndexOf("/");subOffset>0&&(sub=id.substring(subOffset+1),id=id.substring(0,subOffset));let list=info.list;for(let i=0;i<list.length;i++){let ele=list[i];if(ele&&ele.id===id){item=ele,i>0&&setNextButton("previousButton",(list[i-1]||{}).id),i<list.length-1&&setNextButton("nextButton",(list[i+1]||{}).id),nextContainer&&!settings.disableNext&&list.length>1&&delete nextContainer.style;break}}if(!item){let newId,redir=info.redir;if(redir&&(newId=redir[id]),newId){id=newId;for(let i=0;i<list.length;i++){let ele=list[i];if(ele&&ele.id===id){item=ele,i>0&&setNextButton("previousButton",(list[i-1]||{}).id),i<list.length-1&&setNextButton("nextButton",(list[i+1]||{}).id),nextContainer&&!settings.disableNext&&list.length>1&&delete nextContainer.style;break}}}}sub=getSubFile(item,sub).file}if(!item||item.invalid){setChildChildren("title",settings.disableTitle?void 0:info.name);let cnt=getChildModel("content");if(cnt){if(delete cnt.data,cnt.styleRefs="x-part-blog-menu",cnt.children=[],settings.banner instanceof Array)for(let i=0;i<settings.banner.length;i++){let banner=settings.banner[i];banner&&cnt.children.push(banner)}cnt.children.push({tagName:"ul",styleRefs:"link-tile-compact",children:genMenu(!0)})}return context.refresh(),void scrollToTop()}setChildChildren("title",item.name),genNotification(site.getString("loading")),context.refresh();let relaPath="/"+(settings.rootPath||"blog");try{let testRootPath=relaPath+"/";location.pathname.endsWith(testRootPath)&&(relaPath=".")}catch(ex){}let url=relaPath+item.url;return sub&&(url=relaPath+"/"+item.dir+"/"+item.file+"/"+sub),function(url){return"undefined"==typeof fetch?"function"==typeof $&&"function"==typeof $.get?$.get(url):new Promise((function(resolve,reject){reject("Not implemented")})):fetch(url).then((function(r){return r.text()}))}(url).then((function(r2){r2=sub?sub.indexOf("/")>0?r2.replace(/\(..\/..\//g,"("+relaPath+item.dir+"/").replace(/\(..\//g,"("+relaPath+item.dir+"/"+item.file+"/"):r2.replace(/\(..\//g,"("+relaPath+item.dir+"/").replace(/\(.\//g,"("+relaPath+item.dir+"/"+item.file+"/"):item.url.endsWith("/README.md")?r2.replace(/\(..\//g,"("+relaPath+item.dir+"/").replace(/\(.\//g,"("+relaPath+item.dir+"/"+item.id+"/"):r2.replace(/\(.\//g,"("+relaPath+item.dir+"/");let header1="# "+item.name+"\n";if(r2.startsWith(header1)&&(r2=r2.substring(header1.length)),header1="# "+item.name+"\r\n",r2.startsWith(header1)&&(r2=r2.substring(header1.length)),item.end){let endTag="\n\x3c!-- "+(!0===item.end?"End":item.end)+" --\x3e",endIndex=r2.lastIndexOf(endTag);endIndex>1&&(r2=r2.substring(0,endIndex))}let noteEles=[];if(item.author&&("string"==typeof item.author&&(item.author={name:item.author}),item.author.name&&!item.author.hide&&noteEles.push(item.author.url?{tagName:"a",props:{href:item.author.url},children:item.author.name}:{tagName:"span",children:item.author.name})),"string"==typeof item.date&&item.date.length>7&&item.date.indexOf("-")<0){let time=new Date(parseInt(item.date.substring(0,4)),parseInt(item.date.substring(4,6))-1,parseInt(item.date.substring(6,8)));isNaN(time)?noteEles.push({tagName:"time",props:{datetime:item.date.substring(0,4)},children:"'"+item.date.substring(0,4)}):noteEles.push({tagName:"time",props:{datetime:time.getFullYear().toString(10)+"-"+(time.getMonth()+1).toString(10)+"-"+time.getDate().toString(10)},children:time.toLocaleDateString()}),"string"==typeof item.location&&(noteEles[noteEles.length-1].children+="  "+item.location)}if(item.categories&&item.categories instanceof Array&&item.categories.length>0)for(let i=0;i<item.categories.length;i++){let category=item.categories[i];category&&noteEles.push({tagName:"span",children:category})}setChildChildren("note",noteEles);let cnt=getChildModel("content");if(cnt&&(cnt.data={value:r2,sub:sub,id:id,data:item.data},delete cnt.styleRefs,delete cnt.children),item.notes&&("string"==typeof item.notes&&(item.notes=[item.notes]),item.notes instanceof Array))for(let i=0;i<item.notes.length;i++){let noteLine=item.notes[i];noteLine&&relatedContainer.children.push({tagName:"p",children:[{tagName:"span",children:noteLine}]})}if(item.related&&item.related.length>0){let relatedList=item.related.map((function(ele){return ele&&ele.name&&ele.url?{tagName:"li",children:[{tagName:"a",props:{href:ele.url},children:ele.subtitle?[{tagName:"span",children:ele.name},{tagName:"span",children:ele.subtitle}]:ele.name}]}:null})).filter((function(ele){return null!=ele}));relatedList.length>0&&(relatedContainer.children.push({tagName:"h2",children:site.getString("seeAlso")}),relatedContainer.children.push({tagName:"ul",styleRefs:"link-tile-compact",children:relatedList}))}!sub&&relatedContainer.children.length>0&&delete relatedContainer.style,highlightSelected(item.id),context.refresh()}),(function(r){genNotification(site.getString("loadFailed")),context.refresh(),scrollToTop()})),scrollToTop(),id}function genMenu(showDesc,list,callback){let col=[];if(list||(list=info.list),!list)return col;let year=null;if("string"==typeof callback){let path=callback;callback=function(link){delete link.on,link.props.href&&(link.props.href="./"+path+"/?"+link.props.href.substring(1))}}return list.forEach((function(item){if(!item||item.invalid)return;if("string"==typeof item)return void col.push({tagName:"li",styleRefs:"grouping-header",children:item});if("string"==typeof item.date&&item.date.length>3){let y=item.date.substring(0,4);y!==year&&col.push({tagName:"li",styleRefs:"grouping-header",children:y}),year=y}let text=item.menu||item.name;showDesc&&item.desc&&(text=[{tagName:"span",children:item.menu||item.name||item.subtitle},{tagName:"br"},{tagName:"span",children:item.desc}]),text?"string"==typeof text&&item.subtitle&&(text=[{tagName:"span",children:item.menu||item.name},{tagName:"span",children:item.subtitle}]):text=item.subtitle;let link={tagName:"a",props:{href:"?"+item.id},on:{click(ev){ev.preventDefault?ev.preventDefault():ev.returnValue=!1,site.goto(item.id)}},children:text};"function"==typeof callback&&callback(link),col.push({tagName:"li",data:item.id,children:[link]})})),col}function formatMenuItem(item,prefix){if(!item)return;if(!item.url||item.url.length<10||!item.name)return void(item.invalid=!0);let offset=item.url.indexOf("/",3);offset<0&&(offset=5);let fileName=item.url.substring(offset+1),fileExtPos=fileName.indexOf("."),fileExt=fileExtPos>=0?fileName.substring(fileExtPos+1):"";if(fileName=fileExtPos>0?fileName.substring(0,fileExtPos):"",fileName){if(fileName.endsWith("/README")&&(fileName=fileName.substring(0,fileName.length-7)),item.file=fileName,item.menu=prefix?prefix+item.name:item.name,item.id||(item.id=fileName),!item.date&&5===offset){let fileDate=item.url.substring(1,5).replace("/","").replace("/","");isNaN(parseInt(fileDate))||(item.date=fileDate)}item.type||(item.type=fileExt),item.dir=item.url.substring(0,offset)}else item.invalid=!0}function pushWiki(col,wiki,indent){if(!wiki||wiki.length<1)return;let prefix="";if(indent>0){for(let i=1;i<indent;i++)prefix+="　";prefix+="▹ "}indent++;for(let i=0;i<wiki.length;i++){let item=wiki[i];item&&("string"!=typeof item?(formatMenuItem(item,prefix),col.push(item),item.children&&pushWiki(col,item.children,indent)):col.push(item))}}function getMenu(list,wiki){let col=[];if(pushWiki(col,wiki,0),list&&list.length>0)for(let i=list.length-1;i>=0;i--){let item=list[i];item&&(formatMenuItem(item),col.push(item))}return col}function configUrl(){return settings.menuPath?settings.menuPath:initMarket()+".json"}function render(){if(!rootContext)return;if(!rootContext.model())return;highlightSelected(void 0);let id=site.firstQuery();fetchJson(configUrl()).then((function(r){r&&(setChildChildren("blogTitle",r.name||site.getString("articles")),info.list=getMenu(r.list,r.wiki),info.redir=r.redir,info.name=r.name,setChildChildren("articles",genMenu()),renderArticle(id))}),(function(r){genNotification(site.getString("loadFailed")),rootContext.refresh()}))}site.regStrings=function(map){let keys=Object.keys(map);for(let i=0;i<keys.length;i++){let key=keys[i];key?strings[key]=map[key]:delete strings[key]}},site.headings=function(ele){return ele?getHeadings(ele):null},site.query=function(name){if(url=location.search,null==name)return null;try{if("string"==typeof name){let result=url.match(new RegExp("[?&]"+name+"=([^&]+)","i"));return null==result||result.length<1?"":notToDecode?result[1]:decodeURIComponent(result[1])}if("number"==typeof name){let result=url.match(new RegExp("[?&][^?&]+=[^?&]+","g"));return null==result?"":notToDecode?result[name].substring(1):decodeURIComponent(result[name].substring(1))}}catch(ex){}return null},site.firstQuery=function(){let id=location.search;if(id&&id.length>1){id=id.substring(1);let idEndPos=id.indexOf("?");idEndPos>=0&&(id=id.substring(0,idEndPos)),idEndPos=id.indexOf("&"),idEndPos>=0&&(id=id.substring(0,idEndPos))}return id},site.getString=function(key,element){if(!key||"string"!=typeof key)return;let s=strings.value[key];if(!s){let mkt=initMarket();s=(strings[mkt]||strings.en)[key]}return s?(element&&("string"==typeof element&&(element=document.getElementById(element)),element&&element.tagName&&(element.innerText=s)),s):s},site.showElements=function(show,hide){show&&show.forEach((function(ele){let element=document.getElementById(ele);element&&(element.style.display="")})),hide&&hide.forEach((function(ele){let element=document.getElementById(ele);element&&(element.style.display="none")}))},site.head=function(ext,menu,needInsert){let cntEle=document.createElement("header");cntEle.id="page_head";let link,name="Kingcean",glue=!1;if("string"==typeof ext){let i=ext.indexOf(".");0==i?ext=ext.substring(1):i>0&&(name=ext.substring(0,i),ext=ext.substring(i+1))}else ext&&ext.name?(ext.name&&(name=ext.name),link=ext.url,glue=ext.glue,ext=ext.ext||"com"):ext="org";link||(link="https://"+name.toLowerCase()+"."+ext),cntEle.innerHTML='<section><h1><a href="'+link+'"><strong>'+name+"</strong><span>"+(glue?"":".")+ext+"</span></a></h1><ul>"+menu.map((ele=>'<li><a href="'+ele.url+'">'+ele.name+"</a></li>")).join("")+"</ul></section>",needInsert?document.body.insertBefore(cntEle,document.body.children[0]):document.body.appendChild(cntEle)},site.blogMenu=function(url){return url?"string"==typeof url&&(url={url:url}):url={},url.url||(url.url=configUrl()),fetchJson(url.url).then((function(r){if(!r)return;let col=getMenu(r.list,r.wiki);return{tagName:"ul",styleRefs:"link-tile-compact",children:genMenu(url.desc,col,url.onItem)}}))},site.goto=function(id){renderArticle(id),id?history.pushState({id:id},"","?"+id):history.pushState({},"","./")},site.blogs=function(options){let cntEle=document.getElementById("blog_content");cntEle||(cntEle=document.createElement("section"),cntEle.id="blog_content",document.body.appendChild(cntEle)),options&&(settings=options);let hasInit=null!=rootContext;hasInit?render():(hasInit=!0,rootContext=Hje.render(cntEle,{children:[{tagName:"article",children:[{key:"title",tagName:"h1"},{key:"note",tagName:"section",styleRefs:"x-part-blog-note"},{key:"content",tagName:"main",children:[{tagName:"em",children:site.getString("loading")}],onInit(c){let mdEle=c.element(),mdModel=c.model();if(!mdEle||!mdModel||!mdModel.data||mdModel.data.done)return;mdModel.data.done=!0,options={id:mdModel.data.id,sub:mdModel.data.sub,data:mdModel.data.data},function(element,md,options){let done=!1;try{if("function"==typeof settings.renderMarkdown&&(done=settings.renderMarkdown(element,md,options)),done)return;"object"==typeof marked&&"function"==typeof marked.parse?element.innerHTML=marked.parse(md):element.innerText=md}catch(ex){element.innerText=site.getString("renderFailed")}}(mdEle,mdModel.data.value,options);let eles=mdEle.getElementsByTagName("a"),list=info.list;for(let i=0;i<eles.length;i++){let ele=eles[i];if(!ele||!ele.href)continue;let eleUrl=ele.getAttribute("href");if(!eleUrl)continue;if(!eleUrl.startsWith("./"))continue;eleUrl=eleUrl.substring(1),eleUrl.endsWith("/README.md")?eleUrl=eleUrl.substring(0,eleUrl.length-10):eleUrl.endsWith("/")&&(eleUrl=eleUrl.substring(0,eleUrl.length-1));let eleUrlArr=eleUrl.split("/");if(eleUrlArr.length<3||eleUrlArr.length>4)continue;let enableSub=4==eleUrlArr.length&&eleUrlArr[3];for(let j=0;j<list.length;j++){let article=list[j];if(!article||!article.id)continue;let subPath=article.id;if(enableSub){if(article.id!==eleUrlArr[2]||!article.subs||article.dir!=="/"+eleUrlArr[1])continue;let subFile=getSubFile(article,eleUrlArr[3]).id;if(!subFile)continue;subPath+="/"+subFile}else{let articleUrl=article.dir+"/"+article.id;if(article.url!==eleUrl&&articleUrl!==eleUrl)continue}ele.href="?"+subPath,ele.addEventListener("click",(function(ev){ev.preventDefault?ev.preventDefault():ev.returnValue=!1,site.goto(subPath)}));break}}let contentMenu=getChildModel("cntMenu");if("function"==typeof settings.onRenderArticle&&settings.onRenderArticle(mdEle,options),settings.disableArticleMenu||!contentMenu)return;let headers=getHeadings(mdEle),levels=function(arr){if(!arr||arr.length<1)return[];let list=[];for(let level=1;level<7;level++)for(let i=0;i<arr.length;i++){let item=arr[i];if(item&&item.level==level){list.push(level);break}}return list}(headers);if(!headers||headers.length<2||levels.length<1)resetContentMenu();else{delete contentMenu.style,contentMenu.children=[],contentMenu.children.push({tagName:"li",children:[{tagName:"a",props:{href:"javascript:void(0)"},on:{click(ev){scrollToTop()}},children:"⇮ "+site.getString("top")}]}),1==levels.length&&levels.push(levels[0]+1);for(let i=0;i<headers.length;i++){let item=headers[i];switch(item.level){case levels[0]:contentMenu.children.push(genHeadModel(item));break;case levels[1]:contentMenu.children.push(genHeadModel(item,!0))}}!function(key){try{return rootContext.childContext(key).refresh()}catch(ex){}}("cntMenu")}}},{key:"relatedContainer",styleRefs:"x-part-blog-related",tagName:"section",style:{display:"none"},children:[]},{key:"nextSection",tagName:"section",styleRefs:"x-part-blog-next",style:{display:"none"},children:[{key:"previousButton",tagName:"a",props:{disabled:!0,href:"javascript:void(0)",title:site.getString("previous")},children:"<",on:{click(ev){let m=getChildModel("previousButton");m&&site.goto(m.data)}}},{key:"nextButton",tagName:"a",props:{disabled:!0,href:"javascript:void(0)",title:site.getString("next")},children:site.getString("next")+"　>",on:{click(ev){let m=getChildModel("nextButton");m&&site.goto(m.data)}}}]}]},{tagName:"aside",children:[{tagName:"nav",children:[{key:"cntMenu",tagName:"ul",styleRefs:"link-tile-compact",children:[],style:{display:"none"}},{tagName:"h1",children:[{key:"blogTitle",tagName:"a",props:{href:"./"},on:{click(ev){ev.preventDefault?ev.preventDefault():ev.returnValue=!1,site.goto(void 0)}}}]},{key:"articles",tagName:"ul",styleRefs:"link-tile-compact",children:[]}]}]}]}),render(),window.addEventListener("popstate",(function(ev){renderArticle(ev.state?ev.state.id:void 0)})))}}(site||(site={}));